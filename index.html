<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PED Pressure Rating Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#FF7D00',
                        danger: '#F53F3F',
                        neutral: '#86909C',
                        'neutral-light': '#F2F3F5',
                        'neutral-dark': '#1D2129'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .card-hover {
                @apply hover:shadow-lg hover:-translate-y-1 transition-all duration-300;
            }
            .log-scale-tick {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-neutral-dark min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-tachometer text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">PED Pressure Rating Tool</h1>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-neutral hover:text-primary transition-all-300">Home</a>
                <a href="#" class="text-neutral hover:text-primary transition-all-300">Documentation</a>
                <a href="#" class="text-neutral hover:text-primary transition-all-300">About PED</a>
                <a href="#" class="text-neutral hover:text-primary transition-all-300">Contact</a>
            </div>
            <button class="md:hidden text-neutral text-xl">
                <i class="fa fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 页面标题 -->
        <div class="text-center mb-10">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-3">Pressure Equipment Directive (PED) Rating Calculator</h2>
            <p class="text-neutral max-w-3xl mx-auto">Determine the PED pressure rating for your equipment based on type, fluid, pressure, and volume/DN parameters.</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 输入表单 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-soft p-6 card-hover">
                    <h3 class="text-xl font-semibold mb-5 flex items-center">
                        <i class="fa fa-sliders text-primary mr-2"></i>
                        Input Parameters
                    </h3>
                    
                    <form id="calculatorForm" class="space-y-5">
                        <!-- 设备类型 -->
                        <div>
                            <label for="equipmentType" class="block text-sm font-medium text-neutral-dark mb-1">Equipment Type <span class="text-danger">*</span></label>
                            <select id="equipmentType" name="equipmentType" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300">
                                <option value="" disabled selected>Select equipment type</option>
                                <option value="vessel">Vessel</option>
                                <option value="piping">Piping</option>
                                <option value="steam-generator">Steam Generator</option>
                            </select>
                        </div>
                        
                        <!-- 流体类型 -->
                        <div id="fluidTypeContainer">
                            <label for="fluidType" class="block text-sm font-medium text-neutral-dark mb-1">Fluid Type <span class="text-danger">*</span></label>
                            <select id="fluidType" name="fluidType" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300">
                                <option value="" disabled selected>Select fluid type</option>
                                <option value="group1gas">Group 1 Gas</option>
                                <option value="group2gas">Group 2 Gas</option>
                                <option value="group1liquid">Group 1 Liquid</option>
                                <option value="group2liquid">Group 2 Liquid</option>
                            </select>
                        </div>
                        
                        <!-- 压力 -->
                        <div>
                            <label for="pressure" class="block text-sm font-medium text-neutral-dark mb-1">Pressure (bar) <span class="text-danger">*</span></label>
                            <div class="relative">
                                <input type="number" id="pressure" name="pressure" min="0.5" step="0.1" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300"
                                    placeholder="Enter pressure value">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <span class="text-neutral">bar</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 体积或DN -->
                        <div id="volumeOrDNContainer">
                            <label for="volume" class="block text-sm font-medium text-neutral-dark mb-1">Volume (L) <span class="text-danger">*</span></label>
                            <div class="relative">
                                <input type="number" id="volume" name="volume" min="0.1" step="0.1" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300"
                                    placeholder="Enter volume value">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <span class="text-neutral">L</span>
                                </div>
                            </div>
                            
                            <div id="dnContainer" class="hidden">
                                <label for="dn" class="block text-sm font-medium text-neutral-dark mb-1">Nominal Diameter (DN) <span class="text-danger">*</span></label>
                                <div class="relative">
                                    <input type="number" id="dn" name="dn" min="0.1" step="1" required
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300"
                                        placeholder="Enter DN value">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <span class="text-neutral">DN</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all-300 flex items-center justify-center">
                            <i class="fa fa-calculator mr-2"></i>
                            Calculate Pressure Rating
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- 结果展示 -->
            <div class="lg:col-span-2">
                <!-- 结果卡片 -->
                <div class="bg-white rounded-xl shadow-soft p-6 mb-8 card-hover">
                    <h3 class="text-xl font-semibold mb-5 flex items-center">
                        <i class="fa fa-line-chart text-primary mr-2"></i>
                        PSV Diagram & Result
                    </h3>
                    
                    <!-- 初始状态提示 -->
                    <div id="initialState" class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
                            <i class="fa fa-info text-2xl"></i>
                        </div>
                        <p class="text-neutral">Please fill in the parameters and click "Calculate Pressure Rating" to view the results.</p>
                    </div>
                    
                    <!-- 结果显示区域（默认隐藏） -->
                    <div id="resultArea" class="hidden">
                        <!-- 结果摘要 -->
                        <div class="bg-neutral-light rounded-lg p-4 mb-6">
                            <h4 class="font-semibold mb-2">Rating Result</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <p class="text-sm text-neutral">Equipment Type</p>
                                    <p id="resultEquipmentType" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-neutral">Fluid Type</p>
                                    <p id="resultFluidType" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-neutral" id="paramLabel">Pressure/Volume</p>
                                    <p id="resultParams" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-neutral">Pressure Rating</p>
                                    <p id="resultRating" class="font-medium text-primary"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PSV图表 -->
                        <div class="relative">
                            <div class="aspect-[4/3] bg-neutral-light/50 rounded-lg overflow-hidden mb-4">
                                <!-- PSV图将在这里显示 -->
                                <canvas id="psvChart" class="w-full h-full"></canvas>
                            </div>
                            <div class="text-sm text-neutral text-center">
                                PSV Diagram with highlighted rating area for selected parameters
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 信息卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-soft p-6 card-hover">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fa fa-info-circle text-primary mr-2"></i>
                            About PED Ratings
                        </h3>
                        <p class="text-neutral text-sm">The Pressure Equipment Directive (PED) classifies equipment based on pressure, volume/DN, and fluid properties. This classification determines the conformity assessment procedures required.</p>
                        <a href="#" class="text-primary text-sm mt-3 inline-block hover:underline">Learn more about PED →</a>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-soft p-6 card-hover">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fa fa-lightbulb-o text-primary mr-2"></i>
                            How to Use
                        </h3>
                        <p class="text-neutral text-sm">Select your equipment type, fluid type, enter pressure and volume/DN values, then click calculate. The corresponding PSV diagram will show your rating classification.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-neutral text-sm">© 2023 PED Pressure Rating Tool. All rights reserved.</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-neutral hover:text-primary transition-all-300">
                        <i class="fa fa-file-text-o"></i> Terms
                    </a>
                    <a href="#" class="text-neutral hover:text-primary transition-all-300">
                        <i class="fa fa-shield"></i> Privacy
                    </a>
                    <a href="#" class="text-neutral hover:text-primary transition-all-300">
                        <i class="fa fa-envelope"></i> Contact
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // 全局变量
        let psvChart = null;
        let currentChartType = '';
        
        // DOM元素
        const equipmentTypeSelect = document.getElementById('equipmentType');
        const fluidTypeSelect = document.getElementById('fluidType');
        const fluidTypeContainer = document.getElementById('fluidTypeContainer');
        const volumeContainer = document.getElementById('volume').parentElement.parentElement;
        const dnContainer = document.getElementById('dnContainer');
        const paramLabel = document.getElementById('paramLabel');
        const calculatorForm = document.getElementById('calculatorForm');
        const initialState = document.getElementById('initialState');
        const resultArea = document.getElementById('resultArea');
        
        // 结果显示元素
        const resultEquipmentType = document.getElementById('resultEquipmentType');
        const resultFluidType = document.getElementById('resultFluidType');
        const resultParams = document.getElementById('resultParams');
        const resultRating = document.getElementById('resultRating');
        
        // 9种PSV图表的数据模型
        const psvChartsData = {
            // Chart 1 - Vessels for Group 1 gases
            'vessel-group1gas': {
                type: 'volume',
                title: 'Vessels for Group 1 Gases',
                xLabel: 'Volume (L)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·V=25', points: [{v:0.1, p:250}, {v:10000, p:0.0025}]},
                    {line: 'PS·V=50', points: [{v:0.1, p:500}, {v:10000, p:0.005}]},
                    {line: 'PS·V=200', points: [{v:0.1, p:2000}, {v:10000, p:0.02}]},
                    {line: 'PS·V=1000', points: [{v:0.1, p:10000}, {v:10000, p:0.1}]},
                    {line: 'PS=0.5', points: [{v:0.1, p:0.5}, {v:10000, p:0.5}]},
                    {line: 'PS=200', points: [{v:0.1, p:200}, {v:5, p:200}]},
                    {line: 'PS=1000', points: [{v:0.1, p:1000}, {v:1, p:1000}]},
                    {line: 'V=1', points: [{v:1, p:0.5}, {v:1, p:1000}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, v) => (p * v < 25 || (v <= 1 && p < 200)) && p < 200 && p >= 0.5
                    },
                    {
                        id: 'II',
                        conditions: (p, v) => (p * v >= 25 && p * v < 50) && p < 200 && p >= 0.5
                    },
                    {
                        id: 'III',
                        conditions: (p, v) => (p * v >= 50 && p * v < 1000) || (v <= 1 && p >= 200 && p < 1000)
                    },
                    {
                        id: 'IV',
                        conditions: (p, v) => (p * v >= 1000) || (v <= 1 && p >= 1000) || p >= 1000
                    }
                ]
            },
            
            // Chart 2 - Vessels for Group 2 gases
            'vessel-group2gas': {
                type: 'volume',
                title: 'Vessels for Group 2 Gases',
                xLabel: 'Volume (L)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·V=50', points: [{v:0.1, p:500}, {v:10000, p:0.005}]},
                    {line: 'PS·V=200', points: [{v:0.1, p:2000}, {v:10000, p:0.02}]},
                    {line: 'PS·V=1000', points: [{v:0.1, p:10000}, {v:10000, p:0.1}]},
                    {line: 'PS·V=3000', points: [{v:0.1, p:30000}, {v:10000, p:0.3}]},
                    {line: 'PS=0.5', points: [{v:0.1, p:0.5}, {v:10000, p:0.5}]},
                    {line: 'PS=4', points: [{v:400, p:4}, {v:10000, p:4}]},
                    {line: 'PS=1000', points: [{v:0.1, p:1000}, {v:3, p:1000}]},
                    {line: 'PS=3000', points: [{v:0.1, p:3000}, {v:1, p:3000}]},
                    {line: 'V=1', points: [{v:1, p:0.5}, {v:1, p:3000}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, v) => (p * v < 50 || (v <= 1 && p < 1000)) && p < 1000 && p >= 0.5
                    },
                    {
                        id: 'II',
                        conditions: (p, v) => (p * v >= 50 && p * v < 200) && p < 1000 && p >= 0.5
                    },
                    {
                        id: 'III',
                        conditions: (p, v) => (p * v >= 200 && p * v < 3000) || (v <= 1 && p >= 1000 && p < 3000) || (v > 400 && p >=4 && p < 0.5*(30000/p))
                    },
                    {
                        id: 'IV',
                        conditions: (p, v) => (p * v >= 3000) || (v <= 1 && p >= 3000) || (v > 400 && p >=4)
                    }
                ]
            },
            
            // Chart 3 - Vessels for Group 1 liquids
            'vessel-group1liquid': {
                type: 'volume',
                title: 'Vessels for Group 1 Liquids',
                xLabel: 'Volume (L)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·V=200', points: [{v:0.1, p:2000}, {v:10000, p:0.02}]},
                    {line: 'PS=0.5', points: [{v:0.1, p:0.5}, {v:10000, p:0.5}]},
                    {line: 'PS=10', points: [{v:20, p:10}, {v:10000, p:10}]},
                    {line: 'PS=500', points: [{v:1, p:500}, {v:10000, p:500}]},
                    {line: 'V=1', points: [{v:1, p:0.5}, {v:1, p:10000}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, v) => (p * v < 200 && p < 10) || (v <= 1 && p < 500)
                    },
                    {
                        id: 'II',
                        conditions: (p, v) => (p * v >= 200 && p < 10) || (p >=10 && p < 500) || (v > 1 && p >=500)
                    },
                    {
                        id: 'III',
                        conditions: (p, v) => p >= 500
                    }
                ]
            },
            
            // Chart 4 - Vessels for Group 2 liquids
            'vessel-group2liquid': {
                type: 'volume',
                title: 'Vessels for Group 2 Liquids',
                xLabel: 'Volume (L)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·V=10000', points: [{v:10, p:1000}, {v:10000, p:1}]},
                    {line: 'PS=0.5', points: [{v:0.1, p:0.5}, {v:10000, p:0.5}]},
                    {line: 'PS=10', points: [{v:1000, p:10}, {v:10000, p:10}]},
                    {line: 'PS=500', points: [{v:20, p:500}, {v:10000, p:500}]},
                    {line: 'PS=1000', points: [{v:0.1, p:1000}, {v:10, p:1000}]},
                    {line: 'V=10', points: [{v:10, p:0.5}, {v:10, p:1000}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, v) => (p * v < 10000 && p < 10) || (v <= 10 && p < 1000)
                    },
                    {
                        id: 'II',
                        conditions: (p, v) => (p * v >= 10000 && p < 500) || (p >=10 && p < 500) || (v > 10 && p >=1000 && p < 500)
                    },
                    {
                        id: 'III',
                        conditions: (p, v) => p >= 500
                    }
                ]
            },
            
            // Chart 5 - Steam Generators
            'steam-generator': {
                type: 'volume',
                title: 'Steam Generators',
                xLabel: 'Volume (L)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·V=50', points: [{v:2, p:25}, {v:1000, p:0.05}]},
                    {line: 'PS·V=200', points: [{v:2, p:100}, {v:1000, p:0.2}]},
                    {line: 'PS·V=3000', points: [{v:2, p:1500}, {v:1000, p:3}]},
                    {line: 'PS=0.5', points: [{v:0.1, p:0.5}, {v:10000, p:0.5}]},
                    {line: 'PS=32', points: [{v:2, p:32}, {v:93.75, p:32}]},
                    {line: 'V=2', points: [{v:2, p:0.5}, {v:2, p:1500}]},
                    {line: 'V=1000', points: [{v:1000, p:0.5}, {v:1000, p:3}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, v) => (p * v < 50 && v > 2) || (v <= 2 && p < 32)
                    },
                    {
                        id: 'II',
                        conditions: (p, v) => (p * v >= 50 && p * v < 200) && v > 2
                    },
                    {
                        id: 'III',
                        conditions: (p, v) => (p * v >= 200 && p * v < 3000) && v > 2
                    },
                    {
                        id: 'IV',
                        conditions: (p, v) => (p * v >= 3000 && v > 2) || (v <= 2 && p >= 32) || v > 1000
                    }
                ]
            },
            
            // Chart 6 - Piping for Group 1 gases
            'piping-group1gas': {
                type: 'dn',
                title: 'Piping for Group 1 Gases',
                xLabel: 'Nominal Diameter (DN)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·DN=1000', points: [{dn:25, p:40}, {dn:100, p:10}]},
                    {line: 'PS·DN=2500', points: [{dn:100, p:25}, {dn:350, p:7.14}]},
                    {line: 'PS=0.5', points: [{dn:0.1, p:0.5}, {dn:10000, p:0.5}]},
                    {line: 'PS=35', points: [{dn:25, p:35}, {dn:100, p:35}]},
                    {line: 'DN=25', points: [{dn:25, p:0.5}, {dn:25, p:40}]},
                    {line: 'DN=100', points: [{dn:100, p:0.5}, {dn:100, p:25}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, dn) => (p * dn < 1000 && dn > 25) || (dn <= 25 && p < 35)
                    },
                    {
                        id: 'II',
                        conditions: (p, dn) => (p * dn >= 1000 && p * dn < 2500) && dn > 25 && dn <= 100
                    },
                    {
                        id: 'III',
                        conditions: (p, dn) => (p * dn >= 2500 && dn > 100) || (dn <= 100 && p >= 35)
                    }
                ]
            },
            
            // Chart 7 - Piping for Group 2 gases
            'piping-group2gas': {
                type: 'dn',
                title: 'Piping for Group 2 Gases',
                xLabel: 'Nominal Diameter (DN)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·DN=1000', points: [{dn:32, p:31.25}, {dn:100, p:10}]},
                    {line: 'PS·DN=3500', points: [{dn:100, p:35}, {dn:250, p:14}]},
                    {line: 'PS·DN=5000', points: [{dn:250, p:20}, {dn:10000, p:0.5}]},
                    {line: 'PS=0.5', points: [{dn:0.1, p:0.5}, {dn:10000, p:0.5}]},
                    {line: 'DN=32', points: [{dn:32, p:0.5}, {dn:32, p:31.25}]},
                    {line: 'DN=100', points: [{dn:100, p:0.5}, {dn:100, p:35}]},
                    {line: 'DN=250', points: [{dn:250, p:0.5}, {dn:250, p:20}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, dn) => (p * dn < 1000 && dn > 32) || (dn <= 32)
                    },
                    {
                        id: 'II',
                        conditions: (p, dn) => (p * dn >= 1000 && p * dn < 3500 && dn > 32 && dn <= 100) || (dn > 100 && dn <= 250 && p * dn < 5000)
                    },
                    {
                        id: 'III',
                        conditions: (p, dn) => (p * dn >= 3500 && dn > 100 && dn <= 250) || (p * dn >= 5000 && dn > 250)
                    }
                ]
            },
            
            // Chart 8 - Piping for Group 1 liquids
            'piping-group1liquid': {
                type: 'dn',
                title: 'Piping for Group 1 Liquids',
                xLabel: 'Nominal Diameter (DN)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·DN=2000', points: [{dn:25, p:80}, {dn:200, p:10}]},
                    {line: 'PS=0.5', points: [{dn:0.1, p:0.5}, {dn:10000, p:0.5}]},
                    {line: 'PS=10', points: [{dn:200, p:10}, {dn:10000, p:10}]},
                    {line: 'PS=500', points: [{dn:25, p:500}, {dn:10000, p:500}]},
                    {line: 'DN=25', points: [{dn:25, p:0.5}, {dn:25, p:500}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, dn) => (p * dn < 2000 && dn > 25) || (p < 10 && dn > 200)
                    },
                    {
                        id: 'II',
                        conditions: (p, dn) => (p * dn >= 2000 && dn > 25 && dn <= 200) || (p >=10 && p < 500 && dn > 200)
                    },
                    {
                        id: 'III',
                        conditions: (p, dn) => p >= 500
                    }
                ]
            },
            
            // Chart 9 - Piping for Group 2 liquids
            'piping-group2liquid': {
                type: 'dn',
                title: 'Piping for Group 2 Liquids',
                xLabel: 'Nominal Diameter (DN)',
                yLabel: 'Pressure (bar)',
                logScale: true,
                boundaries: [
                    {line: 'PS·DN=5000', points: [{dn:200, p:25}, {dn:500, p:10}]},
                    {line: 'PS=0.5', points: [{dn:0.1, p:0.5}, {dn:10000, p:0.5}]},
                    {line: 'PS=10', points: [{dn:500, p:10}, {dn:10000, p:10}]},
                    {line: 'PS=500', points: [{dn:200, p:500}, {dn:10000, p:500}]},
                    {line: 'DN=200', points: [{dn:200, p:0.5}, {dn:200, p:500}]}
                ],
                regions: [
                    {
                        id: 'I',
                        conditions: (p, dn) => (p * dn < 5000 && dn > 200) || (p < 10 && dn > 500)
                    },
                    {
                        id: 'II',
                        conditions: (p, dn) => (p * dn >= 5000 && dn > 200 && dn <= 500) || (p >=10 && p < 500 && dn > 500) || p >=500
                    }
                ]
            }
        };
        
        // 监听设备类型变化，控制流体类型和体积/DN显示
        equipmentTypeSelect.addEventListener('change', function() {
            // 控制流体类型显示
            if (this.value === 'steam-generator') {
                fluidTypeContainer.classList.add('hidden');
                fluidTypeSelect.required = false;
            } else {
                fluidTypeContainer.classList.remove('hidden');
                fluidTypeSelect.required = true;
            }
            
            // 控制体积或DN显示
            if (this.value === 'piping') {
                // 管道类型显示DN输入
                volumeContainer.classList.add('hidden');
                dnContainer.classList.remove('hidden');
                paramLabel.textContent = 'Pressure/DN';
            } else {
                // 容器和蒸汽发生器显示体积输入
                volumeContainer.classList.remove('hidden');
                dnContainer.classList.add('hidden');
                paramLabel.textContent = 'Pressure/Volume';
            }
        });
        
        // 表单提交处理
        calculatorForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 获取表单数据
            const equipmentType = equipmentTypeSelect.value;
            const fluidType = equipmentType === 'steam-generator' ? 'n/a' : fluidTypeSelect.value;
            const pressure = parseFloat(document.getElementById('pressure').value);
            
            // 根据设备类型获取体积或DN值
            let volume, dn, xValue;
            if (equipmentType === 'piping') {
                dn = parseFloat(document.getElementById('dn').value);
                xValue = dn;
            } else {
                volume = parseFloat(document.getElementById('volume').value);
                xValue = volume;
            }
            
            // 确定图表类型
            let chartKey;
            if (equipmentType === 'steam-generator') {
                chartKey = 'steam-generator';
            } else {
                chartKey = `${equipmentType}-${fluidType}`;
            }
            
            currentChartType = chartKey;
            
            // 显示结果区域，隐藏初始状态
            initialState.classList.add('hidden');
            resultArea.classList.remove('hidden');
            
            // 显示输入参数
            resultEquipmentType.textContent = formatEquipmentType(equipmentType);
            resultFluidType.textContent = equipmentType === 'steam-generator' ? 'N/A' : formatFluidType(fluidType);
            
            if (equipmentType === 'piping') {
                resultParams.textContent = `${pressure} bar / ${dn} DN`;
            } else {
                resultParams.textContent = `${pressure} bar / ${volume} L`;
            }
            
            // 计算压力等级
            const rating = calculatePressureRating(chartKey, pressure, xValue);
            resultRating.textContent = `Category ${rating}`;
            
            // 绘制PSV图并高亮显示相应区域
            drawPSVChart(chartKey, pressure, xValue, rating);
            
            // 添加结果显示动画
            resultArea.classList.add('animate-pulse');
            setTimeout(() => {
                resultArea.classList.remove('animate-pulse');
            }, 500);
        });
        
        // 格式化设备类型显示文本
        function formatEquipmentType(type) {
            switch(type) {
                case 'vessel': return 'Vessel';
                case 'piping': return 'Piping';
                case 'steam-generator': return 'Steam Generator';
                default: return type;
            }
        }
        
        // 格式化流体类型显示文本
        function formatFluidType(type) {
            switch(type) {
                case 'group1gas': return 'Group 1 Gas';
                case 'group2gas': return 'Group 2 Gas';
                case 'group1liquid': return 'Group 1 Liquid';
                case 'group2liquid': return 'Group 2 Liquid';
                default: return type;
            }
        }
        
        // 计算压力等级
        function calculatePressureRating(chartKey, pressure, xValue) {
            const chartData = psvChartsData[chartKey];
            if (!chartData || !chartData.regions) return 'Unknown';
            
            // 检查是否在Article 4, paragraph 3区域（压力小于0.5bar）
            if (pressure < 0.5) {
                return 'Article 4, paragraph 3';
            }
            
            // 检查每个等级区域
            for (const region of chartData.regions) {
                if (chartData.type === 'volume') {
                    if (region.conditions(pressure, xValue)) {
                        return region.id;
                    }
                } else { // dn类型
                    if (region.conditions(pressure, xValue)) {
                        return region.id;
                    }
                }
            }
            
            return 'Unknown';
        }
        
        // 绘制PSV图表并高亮显示相应区域
        function drawPSVChart(chartKey, pressure, xValue, rating) {
            const ctx = document.getElementById('psvChart').getContext('2d');
            const chartData = psvChartsData[chartKey];
            
            if (!chartData) return;
            
            // 如果已有图表，先销毁
            if (psvChart) {
                psvChart.destroy();
            }
            
            // 准备数据集
            const datasets = [];
            
            // 添加边界线
            chartData.boundaries.forEach((boundary, index) => {
                const boundaryPoints = boundary.points.map(point => {
                    return {
                        x: chartData.type === 'volume' ? point.v : point.dn,
                        y: point.p
                    };
                });
                
                datasets.push({
                    type: 'line',
                    label: boundary.line,
                    data: boundaryPoints,
                    borderColor: index < 4 ? `rgba(54, 162, 235, ${0.7 + index * 0.05})` : `rgba(255, 99, 132, ${0.5 + (index % 4) * 0.1})`,
                    borderWidth: 1.5,
                    pointRadius: 0,
                    tension: 0,
                    fill: false,
                    order: index + 1 // 确保边界线在区域下方
                });
            });
            
            // 添加区域填充
            if (chartData.regions) {
                chartData.regions.forEach((region, index) => {
                    // 为每个区域创建填充多边形（简化版，实际应根据边界计算）
                    // 这里使用近似方法，实际应用中可能需要更精确的区域定义
                    datasets.push({
                        type: 'scatter',
                        label: `Category ${region.id}`,
                        data: getRegionSamplePoints(chartData, region),
                        backgroundColor: getRegionColor(index),
                        pointRadius: 3,
                        pointHoverRadius: 3,
                        showLine: false,
                        order: 0 // 确保区域在最下方
                    });
                });
            }
            
            // 添加Article 4, paragraph 3区域
            datasets.push({
                type: 'line',
                label: 'Article 4, paragraph 3',
                data: [
                    {x: chartData.logScale ? 0.1 : 0, y: 0.5},
                    {x: chartData.logScale ? 10000 : 10000, y: 0.5}
                ],
                borderColor: 'rgba(153, 102, 255, 0.7)',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                tension: 0,
                fill: true,
                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                fillOpacity: 0.3,
                order: -1
            });
            
            // 添加当前点
            datasets.push({
                label: 'Your Value',
                data: [{x: xValue, y: pressure}],
                backgroundColor: 'rgba(22, 93, 255, 1)',
                borderColor: 'rgba(255, 255, 255, 1)',
                borderWidth: 2,
                pointRadius: 8,
                pointHoverRadius: 10,
                showLine: false,
                order: 100 // 确保点在最上方
            });
            
            // 创建图表配置
            const chartConfig = {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: chartData.logScale ? 'logarithmic' : 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: chartData.xLabel
                            },
                            min: chartData.logScale ? 0.1 : 0,
                            max: 10000,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                },
                                color: '#6B7280',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            type: chartData.logScale ? 'logarithmic' : 'linear',
                            title: {
                                display: true,
                                text: chartData.yLabel
                            },
                            min: chartData.logScale ? 0.1 : 0,
                            max: 10000,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                },
                                color: '#6B7280',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: chartData.title,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label) {
                                        return `${label}: ${context.parsed.y} bar, ${context.parsed.x} ${chartData.type === 'volume' ? 'L' : 'DN'}`;
                                    }
                                    return `${context.parsed.y} bar, ${context.parsed.x} ${chartData.type === 'volume' ? 'L' : 'DN'}`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    }
                }
            };
            
            // 创建图表
            psvChart = new Chart(ctx, chartConfig);
            
            // 高亮显示当前等级区域
            highlightRatingArea(rating);
        }
        
        // 获取区域样本点（用于填充区域）
        function getRegionSamplePoints(chartData, region) {
            const points = [];
            const step = chartData.logScale ? 1.5 : 10;
            let x = chartData.logScale ? 0.1 : 0;
            
            // 生成样本点以填充区域
            while (x <= 10000) {
                // 找到该x值下区域内的y值范围
                for (let y = 0.5; y <= 10000; y *= chartData.logScale ? 1.2 : 1.5) {
                    if (chartData.type === 'volume') {
                        if (region.conditions(y, x)) {
                            points.push({x, y});
                        }
                    } else {
                        if (region.conditions(y, x)) {
                            points.push({x, y});
                        }
                    }
                    
                    if (!chartData.logScale && y > 1000) break;
                }
                
                x = chartData.logScale ? x * step : x + step;
            }
            
            return points;
        }
        
        // 获取区域颜色
        function getRegionColor(index) {
            const colors = [
                'rgba(75, 192, 192, 0.3)',  // 绿色
                'rgba(54, 162, 235, 0.3)',  // 蓝色
                'rgba(255, 206, 86, 0.3)',  // 黄色
                'rgba(255, 99, 132, 0.3)'   // 红色
            ];
            return colors[index % colors.length];
        }
        
        // 高亮显示当前等级区域
        function highlightRatingArea(rating) {
            if (!psvChart || !currentChartType) return;
            
            const chartData = psvChartsData[currentChartType];
            if (!chartData || !chartData.regions) return;
            
            // 重置所有区域的透明度
            psvChart.data.datasets.forEach((dataset, index) => {
                // 区域数据集是 scatter 类型且标签以 "Category" 开头
                if (dataset.type === 'scatter' && dataset.label && dataset.label.startsWith('Category')) {
                    dataset.backgroundColor = dataset.backgroundColor.replace('0.3', '0.1');
                }
            });
            
            // 高亮当前等级区域
            if (rating && !rating.includes('Article')) {
                psvChart.data.datasets.forEach((dataset, index) => {
                    if (dataset.type === 'scatter' && dataset.label === `Category ${rating}`) {
                        dataset.backgroundColor = dataset.backgroundColor.replace('0.1', '0.5');
                    }
                });
            }
            
            psvChart.update();
        }
    </script>
</body>
</html>
    
